local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local local_player = Players.LocalPlayer
local map = workspace:FindFirstChild("Map")
local ghost = workspace:WaitForChild("ServerNPCs"):WaitForChild("GLOBAL")

local evidence_folder = workspace.Dynamic.Evidence
local fingerprints = evidence_folder.Fingerprints
local motions = evidence_folder.MotionGrids
local orbs = evidence_folder.Orbs
local emfs = evidence_folder.EMF

local trackedPart = ghost.PrimaryPart or ghost:FindFirstChildWhichIsA("BasePart")
local bone = map and map:FindFirstChild("Bone")

-- Funci贸n para setear estado (solo colores y texto corto)
local function setStatus(label, state)
    if state == "Yes" then
        label.TextColor3 = Color3.fromRGB(0, 255, 0) -- verde ne贸n
    elseif state == "No" then
        label.TextColor3 = Color3.fromRGB(255, 0, 0) -- rojo ne贸n
    else
        label.TextColor3 = Color3.fromRGB(255, 255, 255) -- blanco ne贸n
    end
end

-- UI principal
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "GhostInfoUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

-- Frame principal m谩s angosto
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 220, 0, 420) -- ancho reducido
mainFrame.Position = UDim2.new(0, 20, 0.25, 0) -- lado izquierdo
mainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
mainFrame.BackgroundTransparency = 0
mainFrame.Parent = screenGui

local frameCorner = Instance.new("UICorner")
frameCorner.CornerRadius = UDim.new(0, 15)
frameCorner.Parent = mainFrame

-- sombra
local shadow = Instance.new("ImageLabel")
shadow.Size = UDim2.new(1, 30, 1, 30)
shadow.Position = UDim2.new(0, -15, 0, -15)
shadow.BackgroundTransparency = 1
shadow.Image = "rbxassetid://1316045217"
shadow.ImageColor3 = Color3.fromRGB(0, 0, 0)
shadow.ImageTransparency = 0.5
shadow.ScaleType = Enum.ScaleType.Slice
shadow.SliceCenter = Rect.new(10, 10, 118, 118)
shadow.Parent = mainFrame

-- Funci贸n para crear botones
local function makeButton(text, yPos)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1, -40, 0, 40)
    btn.Position = UDim2.new(0, 20, 0, yPos)
    btn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.Text = text
    btn.Font = Enum.Font.GothamBold
    btn.TextScaled = true
    btn.Parent = mainFrame

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 20)
    corner.Parent = btn

    return btn
end

local player = game.Players.LocalPlayer
local tpButton = makeButton("Collect Bone", 20)
local tpMotionButton = makeButton("Check PM", 70)
local tpVanButton = makeButton("TP to Van", 120)
local staminaButton = makeButton("Inf Stamina: OFF", 170)

local function getPositionFromInstance(inst)
    if not inst then return nil end
    if inst:IsA("BasePart") then
        return inst.Position
    end
    if inst.PrimaryPart and inst.PrimaryPart:IsA("BasePart") then
        return inst.PrimaryPart.Position
    end
    local p = inst:FindFirstChildWhichIsA("BasePart")
    if p then
        return p.Position
    end
    return nil
end

tpButton.MouseButton1Click:Connect(function()
    if not bone then
        print("Bone not found")
        return
    end

    local character = player.Character or player.CharacterAdded:Wait()
    local hrp = character:FindFirstChild("HumanoidRootPart")
    if not hrp then
        warn("HumanoidRootPart no encontrado")
        return
    end

    local bonePos = getPositionFromInstance(bone)
    if not bonePos then
        warn("No se pudo obtener la posici贸n del bone")
        return
    end

    -- Guardar posici贸n original
    local last_pos = hrp.CFrame

    -- Teleport un poco arriba del bone
    hrp.CFrame = CFrame.new(bonePos + Vector3.new(0, 5, 0))
    task.wait(0.2)

    --  Forzar la c谩mara del jugador a mirar al bone
    local cam = workspace.CurrentCamera
    if cam then
        cam.CFrame = CFrame.new(cam.CFrame.Position, bonePos)
    end

    task.wait(0.2)

    -- Buscar y activar el ProximityPrompt
    local bone_prompt = bone:FindFirstChildOfClass("ProximityPrompt")
    if bone_prompt then
        pcall(function()
            fireproximityprompt(bone_prompt, 1)
        end)
    else
        print("No se encontr贸 el ProximityPrompt")
    end

    task.wait(0.3)

    -- Volver a la posici贸n original
    hrp.CFrame = last_pos
end)


tpMotionButton.MouseButton1Click:Connect(function()
    local motion_grid = evidence_folder.MotionGrids:FindFirstChild("SensorGrid")
    if motion_grid then
        local last_pos = {}
        local ghostModel = workspace.NPCs:FindFirstChildOfClass("Model")
        if ghostModel and ghostModel:FindFirstChild("HumanoidRootPart") then
            for _, grid in pairs(motion_grid:GetChildren()) do
                if grid:IsA("Part") then
                    last_pos[grid] = grid.CFrame
                    grid.CFrame = ghostModel.HumanoidRootPart.CFrame + Vector3.new(1, 0, 0)
                end
            end
            task.wait()
            for part, pos in pairs(last_pos) do
                part.CFrame = pos
            end
        end
    else
        warn("锔 Motion Grids not found!")
    end
end)

tpVanButton.MouseButton1Click:Connect(function()
    local character = player.Character or player.CharacterAdded:Wait()
    local hrp = character:FindFirstChild("HumanoidRootPart")
    local van = workspace:FindFirstChild("Van")
    if hrp and van and van.PrimaryPart then
        hrp.CFrame = van.PrimaryPart.CFrame + Vector3.new(0, 5, 0)
    else
        warn("锔 Van not found!")
    end
end)
-- Funci贸n para a帽adir labels de evidencias
local function makeLabel(text, yPos)
    local lbl = Instance.new("TextLabel")
    lbl.Size = UDim2.new(1, -40, 0, 30)
    lbl.Position = UDim2.new(0, 20, 0, yPos)
    lbl.BackgroundTransparency = 1
    lbl.TextColor3 = Color3.fromRGB(255, 255, 255)
    lbl.TextXAlignment = Enum.TextXAlignment.Center -- CENTRADO
    lbl.TextScaled = true
    lbl.Font = Enum.Font.GothamBold
    lbl.Text = text -- solo el nombre, sin estado inicial
    lbl.Parent = mainFrame
    return lbl
end

-- Labels
local emfLabel = makeLabel("EMF", 220)
local motionLabel = makeLabel("Motion", 260)
local orbLabel = makeLabel("Orbs", 300)
local fingerprintLabel = makeLabel("Fingerprints", 340)
local speedLabel = makeLabel("Ghost Speed: 0", 380)

-- Evidencias
emfs.ChildAdded:Connect(function(emf)
    if emf:IsA("Part") and emf.Name == "EMF5" then
        setStatus(emfLabel, "Yes")
    end
end)

task.delay(120, function()
    if emfLabel.TextColor3 == Color3.fromRGB(255, 255, 255) then
        setStatus(emfLabel, "No")
    end
end)

fingerprints.ChildAdded:Connect(function(fingerprint)
    if fingerprint:IsA("Part") then
        setStatus(fingerprintLabel, "Yes")
    end
end)

task.delay(120, function()
    if fingerprintLabel.TextColor3 == Color3.fromRGB(255, 255, 255) then
        setStatus(fingerprintLabel, "No")
    end
end)

orbs.ChildAdded:Connect(function(orb)
    if orb:IsA("Part") then
        setStatus(orbLabel, "Yes")
    end
end)

task.delay(120, function()
    if orbLabel.TextColor3 == Color3.fromRGB(255, 255, 255) then
        setStatus(orbLabel, "No")
    end
end)

RunService.RenderStepped:Connect(function()
    for _, motion in pairs(motions:GetDescendants()) do
        if motion:IsA("Part") then
            if motion.Color == Color3.fromRGB(252, 52, 52) then
                setStatus(motionLabel, "Yes")
            elseif motion.BrickColor == BrickColor.new("Toothpaste") then
                setStatus(motionLabel, "No")
            end
        end
    end
end)

-- Velocidad del ghost (queda igual que ten铆as)
RunService.RenderStepped:Connect(function()
    local speed = ghost:GetAttribute("Speed") or 0
    speedLabel.Text = "Ghost Speed: " .. string.format("%.1f", speed)
end)

-- ESP
local billboard = Instance.new("BillboardGui")
billboard.Name = "BoneESP"
billboard.Adornee = bone 
billboard.AlwaysOnTop = true
billboard.Size = UDim2.new(0, 100, 0, 50)
billboard.StudsOffset = Vector3.new(0, 2, 0)
billboard.Parent = player:WaitForChild("PlayerGui")

local label = Instance.new("TextLabel")
label.Size = UDim2.new(1, 0, 1, 0)
label.BackgroundTransparency = 1
label.Text = "Bone"
label.TextColor3 = Color3.fromRGB(255, 0, 0)
label.TextScaled = true
label.Parent = billboard

local function createESP(part)
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "GhostESP"
    billboard.Adornee = part
    billboard.Size = UDim2.new(0, 150, 0, 40)
    billboard.AlwaysOnTop = true
    billboard.Parent = part

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.TextColor3 = Color3.fromRGB(255, 0, 0)
    label.TextScaled = true
    label.Font = Enum.Font.SourceSansBold
    label.Text = "Ghost "
    label.Parent = billboard
end

if trackedPart then
    createESP(trackedPart)
end

local inf_stamina = false
local playerconnection

staminaButton.TextColor3 = Color3.fromRGB(255, 0, 0) -- rojo inicial

staminaButton.MouseButton1Click:Connect(function()
    inf_stamina = not inf_stamina

    if inf_stamina then
        staminaButton.Text = "Inf stamina: ON"
        staminaButton.TextColor3 = Color3.fromRGB(0, 255, 0) -- verde ne贸n

        -- conectar loop
        if not playerconnection then
            playerconnection = RunService.RenderStepped:Connect(function()
                local_player:SetAttribute("Stamina", 100)
            end)
        end
    else
        staminaButton.Text = "Inf stamina: OFF"
        staminaButton.TextColor3 = Color3.fromRGB(255, 0, 0) -- rojo ne贸n

        -- desconectar loop
        if playerconnection then
            playerconnection:Disconnect()
            playerconnection = nil
        end
    end
end)






